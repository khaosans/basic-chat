name: Core Functionality Check

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio
        
    - name: Run unit tests
      run: |
        pytest tests/ -v --tb=short --cov=app --cov=reasoning_engine --cov=document_processor --cov=utils --cov=web_search --cov-report=term-missing
        
    - name: Run basic functionality test
      run: |
        python -c "
        try:
            from app import OllamaChat
            print('✅ OllamaChat imported successfully')
            
            from reasoning_engine import ReasoningEngine
            print('✅ ReasoningEngine imported successfully')
            
            from document_processor import DocumentProcessor
            print('✅ DocumentProcessor imported successfully')
            
            from utils.enhanced_tools import EnhancedCalculator
            print('✅ EnhancedCalculator imported successfully')
            
            print('✅ All core modules imported successfully')
        except ImportError as e:
            print(f'❌ Import failed: {str(e)}')
            raise
        "
        
    - name: Test configuration
      run: |
        python -c "
        try:
            from config import config
            print(f'✅ Configuration loaded: {config.ollama_model}')
            print(f'✅ Ollama URL: {config.ollama_url}')
            print(f'✅ Caching enabled: {config.enable_caching}')
        except Exception as e:
            print(f'❌ Configuration test failed: {str(e)}')
            raise
        "